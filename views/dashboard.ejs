<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Schedule Manager</title>
    <link rel="stylesheet" href="/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="/js/login.js"></script>
    <style>
        /* Ensure placeholder has a sensible min-height without injecting styles from EJS */
        .placeholder-min { min-height: 150px; }
    </style>
</head>
<body>

<div class="schedule-container">

        <header class="schedule-header">
            <h1>Student Schedule</h1>
            <p class="subtitle">Combine your work schedule from W2W and class timetable from OSU in one place</p>
            <div class="user-section">
                <div class="user-info">
                    <p class="user-name" id="user-name">Hi, <%= username %></p>
                </div>
                <button class="btn btn-outline header-logout-btn" onclick="handleLogout()">
                    <span>Logout</span>
                </button>
            </div>
            <h3 class="week-range">
                    <%= currentWeekStart %> - <%= currentWeekEnd %>
            </h3>
            <h1>Student Schedule</h1>
            <div class="actions">
                <%# ç¢ºä¿æŒ‰éˆ•èª¿ç”¨æ­£ç¢ºçš„å‡½æ•¸ %>
                <button class="add-event" onclick="openAddEventModal()"><i class="icon">+</i> Add Event</button>
                <button class="import-schedule" onclick="openImportModal()"><i class="icon">â†‘</i> Import Schedule</button>
                <div class="week-navigation">
                    <a href="/dashboard?weekOffset=<%= weekOffset - 1 %>" class ="week-navi">&lt; Previous Week</a>
                    <a href="/dashboard?weekOffset=<%= weekOffset + 1 %>" class ="week-navi">Next Week &gt;</a>
                </div>
            </div>
            <div class="tabs" id="filterTabs">
                <a href="/dashboard" class="tab <%= eventType === '' ? 'active' : '' %>" data-type="all">
                    All Events (<%= allEventCount %>)
                </a>
                <a href="/works" class="tab <%= eventType === 'works' ? 'active' : '' %>" data-type="work">
                    Work Shifts (<%= workEventCount %>)
                </a>
                <a href="/classes" class="tab <%= eventType === 'classes' ? 'active' : '' %>" data-type="class">
                    Classes (<%= classEventCount %>)
                </a>
                
            </div>
        </header>
        <main class="schedule-content">
            <%# æ ¸å¿ƒæ’ç¨‹å…§å®¹ %>
            <% if (Object.keys(eventsByDay).length === 0) { %>
                <div class="placeholder placeholder-min">
                    <h2>No Events Found</h2>
                    <p>Try importing a schedule or adding a new event.</p>
                </div>
            <% } else { %>
                <%# ğŸŒŸ ä¿®æ­£é» 1: ä½¿ç”¨ CSS ä¸­å®šç¾©çš„ .schedule-grid ğŸŒŸ %>
                <div class="schedule-grid">
                    
                    <%# ğŸŒŸ ä¿®æ­£é» 2: ä¿®æ”¹æ—¥æœŸé †åºï¼Œå¾ Monday é–‹å§‹ ğŸŒŸ %>
                    <% const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']; %>
                    
                    <% daysOfWeek.forEach(day => { %>
                        <div class="day-column">
                            <%# ğŸŒŸ ä¿®æ­£é» 3: ä½¿ç”¨ CSS ä¸­å®šç¾©çš„ .day-title ğŸŒŸ %>
                            <h2 class="day-title"><%= day %></h2>
                            <% if (eventsByDay[day] && eventsByDay[day].length > 0) { %>
                                <div class="event-list"> 
                                    <% eventsByDay[day].forEach(event => { %>
                                        <% if (event.type === 'work') { %>
                                            <%- include('work_event_card', { event: event }) %>
                                        <% } else if (event.type === 'class') { %>
                                            <%- include('class_event_card', { event: event }) %>
                                        <% } %>
                                    <% }); %>
                                </div>
                            <% } else { %>
                                <div class="placeholder-card placeholder-min">
                                    <span class="no-events-text">Free day.</span>
                                </div>
                            <% } %>
                        </div>
                    <% }); %>
                </div>
            <% } %>
            
        </main>

    </div>
    <div id="importModal" class="modal-overlay"> 
    <div class="modal-content">
        <div class="modal-header">
            <h2>Import Work Schedule (W2W)</h2>
            <button class="close-button" onclick="closeImportModal()">&times;</button>
        </div>
        
        <div class="tabs-container">
            <div class="tab-content active">
                <form action="/api/upload" method="POST" enctype="multipart/form-data" id="uploadForm">
                    <p>Select your iCalendar (.ics) file exported from When2Work.</p>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="ics-file">Choose File (.ics):</label>
                        <input type="file" name="icsfile" id="ics-file" accept=".ics" required>
                    </div>
                    
                    <div class="modal-footer" style="padding: 0; border-top: none; background: none;">
                        <button type="button" class="btn-cancel" onclick="closeImportModal()">Cancel</button>
                        <button type="submit" class="btn-primary" onclick="closeImportModal()">
                            Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
    </div>
</div>

    <%# å¼•å…¥ import_schedule æ¨¡æ¿ (Modal) - ç¢ºä¿å…¶ ID ç‚º 'importModal' %>
    <%- include('import_schedule') %>

    <%# å¼•å…¥ add_event æ¨¡æ¿ (Modal) - ç¢ºä¿å…¶ ID ç‚º 'addEventModal' %>
    <%- include('add_event') %>

    <script>
        
        // --- 1. Add Event Modal æ§åˆ¶å‡½æ•¸ ---
        
        // é–‹å•Ÿ Add Event Modal (ç”±æŒ‰éˆ•èª¿ç”¨)
        function openAddEventModal() {
            document.getElementById('addEventModal').style.display = 'flex';
        }

        // é—œé–‰ Add Event Modal (ç”± Modal å…§çš„æŒ‰éˆ•å’Œ JS èª¿ç”¨)
        function closeAddEventModal() {
            document.getElementById('addEventModal').style.display = 'none';
            // ç¢ºä¿è¡¨å–®é‡ç½®ï¼Œé€™æœƒæ¸…é™¤è¼¸å…¥æ¬„ä½
            document.getElementById('addEventForm').reset();
            
            // ç”±æ–¼ toggleDateInput() å‡½æ•¸åœ¨ add_event.ejs ä¸­å®šç¾©ï¼Œ
            // é€™è£¡å¯ä»¥é¸æ“‡æ€§åœ°å‘¼å«å®ƒä¾†ç¢ºä¿æ—¥æœŸæ¬„ä½è¢«æ­£ç¢ºéš±è—ã€‚
            // (å‡è¨­ add_event.ejs ä¸­çš„ <script> å·²ç¶“åœ¨é é¢ä¸­åŸ·è¡Œ)
            if (typeof toggleDateInput === 'function') {
                toggleDateInput();
            }
        }
        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }


        /*
        // --- 2. Import Modal æ§åˆ¶å‡½æ•¸ ---
        // å‡è¨­ import_schedule.ejs ä¸­çš„ Modal ID ç‚º 'importModal'
        
        // é–‹å•Ÿ Import Modal (ç”±æŒ‰éˆ•èª¿ç”¨)
        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }


        // --- 3. Add Event Form æäº¤è™•ç† (ğŸŒŸ æ–°å¢é€™æ®µé‚è¼¯ ğŸŒŸ) ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('addEventForm');

            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault(); // é˜»æ­¢é é¢é‡æ–°è¼‰å…¥

                    // æ”¶é›†è¡¨å–®æ•¸æ“š
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        const response = await fetch('/api/add-event', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(result.message);
                            closeAddEventModal();
                            // **é—œéµï¼šé‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ–°äº‹ä»¶**
                            window.location.reload(); 
                        } else {
                            alert('Failed to add event: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Submission error:', error);
                        alert('An error occurred while submitting the event.');
                    }
                });
            }
        });
        */
    </script>

</body>
</html>
