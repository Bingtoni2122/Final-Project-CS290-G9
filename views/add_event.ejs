<%# add_event.ejs %>
<%# é€™æ˜¯ Add New Event çš„æ¨¡æ…‹æ¡†çµæ§‹ï¼Œé è¨­éš±è— %>

<div id="addEventModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <header class="modal-header">
            <h2>Add New Event</h2>
            <%# é—œé–‰æŒ‰éˆ•å‘¼å« JavaScript å‡½æ•¸ closeAddEventModal() %>
            <button class="close-button" onclick="closeAddEventModal()">x</button>
        </header>
        <form id="addEventForm" class="modal-form">
            
            <div class="form-group">
                <label for="eventType">Event Type *</label>
                <select id="eventType" name="eventType" required onchange="toggleDateInput()">
                    <option value="class">Class</option>
                    <option value="work">Work Shift</option>
                </select>
            </div>

            <div class="form-group">
                <label for="summary">Summary *</label>
                <input type="text" id="summary" name="summary" placeholder="Course name or Shift description" required>
            </div>
          
            <%# ğŸŒŸ ä¿®æ­£: ç§»é™¤ style="display: none;" ä»¥ç¢ºä¿æ¬„ä½å§‹çµ‚é¡¯ç¤º ğŸŒŸ %>
            <div class="form-group" id="dateInputGroup">
                <label for="date">Date</label>
                <input type="date" id="date" name="date">
                <%# æ–°å¢æç¤ºæ–‡å­—ï¼Œé€é JS æ ¹æ“š Event Type æ›´æ–°å…§å®¹ %>
                <small id="dateHelpText">Class events use recurring logic; a date is optional. Work Shifts require a specific date.</small>
            </div>
            
            <div class="form-group time-group">
                <div class="time-input">
                    <label for="time_start">Start Time *</label>
                    <input type="time" id="time_start" name="time_start" required>
                </div>
                <div class="time-input">
                    <label for="time_end">End Time *</label>
                    <input type="time" id="time_end" name="time_end" required>
                </div>
            </div>

            <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" placeholder="Building & room number / Position">
            </div>

            <div class="form-group">
                <label for="instructor">Instructor/Supervisor</label>
                <input type="text" id="instructor" name="instructor" placeholder="Professor name or Supervisor name">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3" placeholder="Additional notes or details"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeAddEventModal()">Cancel</button>
                <button type="submit" class="btn-primary">Add Event</button>
            </div>
        </form>
    </div>
</div>

<%# ğŸŒŸ ä¿®æ­£å¾Œçš„ JavaScript å‡½æ•¸ ğŸŒŸ %>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ç¢ºä¿åœ¨é é¢è¼‰å…¥æ™‚åŸ·è¡Œä¸€æ¬¡ï¼Œè¨­ç½®åˆå§‹çš„ required ç‹€æ…‹ (é è¨­ 'class' ä¸éœ€è¦ required)
        toggleDateInput(); 
    });

    function toggleDateInput() {
        const eventType = document.getElementById('eventType').value;
        const dateInput = document.getElementById('date');
        const dateHelpText = document.getElementById('dateHelpText');

        if (eventType === 'work') {
            dateInput.setAttribute('required', 'required'); 
            dateHelpText.innerHTML = 'A specific date is required for Work Shifts (*).';
        } else {
            // ğŸŒŸ ä¿®æ­£: ä¸å†æ§åˆ¶é¡¯ç¤º/éš±è—ï¼Œåªæ§åˆ¶ required å±¬æ€§ ğŸŒŸ
            dateInput.removeAttribute('required'); 
            dateHelpText.innerHTML = 'For Class events, the date is optional (uses recurring logic).';
            // æ¸…ç©ºæ—¥æœŸå€¼ï¼Œé¿å…æäº¤éŒ¯èª¤çš„ç‰¹å®šæ—¥æœŸæ•¸æ“šçµ¦ Class 
            dateInput.value = ''; 
        }
    }
    
    // æ¨¡æ…‹æ¡†æ§åˆ¶å‡½æ•¸
    function openAddEventModal() {
        document.getElementById('addEventModal').style.display = 'flex';
        // ç¢ºä¿é–‹å•Ÿæ™‚æ ¹æ“šç•¶å‰é¸ä¸­å€¼è¨­ç½®æ­£ç¢ºçš„ required ç‹€æ…‹
        toggleDateInput(); 
    }

    function closeAddEventModal() {
        document.getElementById('addEventModal').style.display = 'none';
        document.getElementById('addEventForm').reset();
        // ç¢ºä¿é—œé–‰æ™‚é‡ç½®æ—¥æœŸè¼¸å…¥çš„ required ç‹€æ…‹ï¼ˆé‡ç½®è¡¨å–®å¾Œæœƒåˆ‡å› 'class'ï¼‰
        toggleDateInput(); 
    }

    // ç¢ºä¿ DOM è¼‰å…¥å®Œæˆå¾Œå†æ·»åŠ äº‹ä»¶ç›£è½å™¨
    document.addEventListener('DOMContentLoaded', () => {
    // ... [åŸæœ‰çš„ toggleDateInput, openAddEventModal, closeAddEventModal å‡½æ•¸] ...
    
    // ğŸŒŸ æ–°å¢ï¼šè™•ç†è¡¨å–®æäº¤çš„é‚è¼¯ ğŸŒŸ
    const addEventForm = document.getElementById('addEventForm');
    
    if (addEventForm) {
        addEventForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // é˜»æ­¢è¡¨å–®çš„é è¨­æäº¤è¡Œç‚º
            
            // ç²å–è¡¨å–®æ•¸æ“šä¸¦è½‰æ›ç‚º JSON ç‰©ä»¶
            const formData = new FormData(e.target);
            const eventData = Object.fromEntries(formData.entries());

            // è™•ç† Class äº‹ä»¶ä¸éœ€è¦ date æ¬„ä½ï¼Œç¢ºä¿ç§»é™¤ç©ºå€¼
            if (eventData.eventType === 'class' && !eventData.date) {
                delete eventData.date;
            }

            try {
                const response = await fetch('/api/add-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    closeAddEventModal();
                    // æˆåŠŸå¾Œé‡æ–°æ•´ç†é é¢ä»¥é¡¯ç¤ºæ–°äº‹ä»¶
                    window.location.reload(); 
                } else {
                    // è™•ç†ä¼ºæœå™¨è¿”å›çš„éŒ¯èª¤
                    alert('Error adding event: ' + (result.message || 'Server returned an error.'));
                }
                } catch (error) {
                    console.error('Submission failed:', error);
                    alert('An unexpected network error occurred.');
                }
            });
        }
    });
</script>
